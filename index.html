<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>í•´ì™¸ì†¡ê¸ˆ ì „í™˜ìœ¨ ê°œì„  ì„íŒ©íŠ¸ ê³„ì‚°ê¸°</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', system-ui, sans-serif;
      background: #f5f5f7;
      min-height: 100vh;
      padding: 40px 20px;
      color: #1d1d1f;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .container {
      max-width: 980px;
      margin: 0 auto;
    }

    h1 {
      text-align: center;
      color: #1d1d1f;
      font-size: 2.5rem;
      font-weight: 700;
      margin-bottom: 12px;
      letter-spacing: -0.015em;
    }

    .subtitle {
      text-align: center;
      color: #86868b;
      font-size: 1.25rem;
      font-weight: 400;
      margin-bottom: 48px;
      letter-spacing: -0.01em;
    }

    .calculator {
      background: rgba(255, 255, 255, 0.8);
      backdrop-filter: saturate(180%) blur(20px);
      -webkit-backdrop-filter: saturate(180%) blur(20px);
      border-radius: 18px;
      padding: 32px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07), 0 10px 20px rgba(0, 0, 0, 0.06);
      border: 0.5px solid rgba(0, 0, 0, 0.04);
    }

    .section {
      margin-bottom: 48px;
    }

    .section-title {
      font-size: 1.5rem;
      font-weight: 600;
      color: #1d1d1f;
      margin-bottom: 24px;
      letter-spacing: -0.02em;
    }

    .funnel-container {
      display: -webkit-box;
      display: -webkit-flex;
      display: flex;
      -webkit-box-orient: vertical;
      -webkit-box-direction: normal;
      -webkit-flex-direction: column;
      flex-direction: column;
      gap: 12px;
    }

    .funnel-step {
      background: #f5f5f7;
      border-radius: 12px;
      padding: 20px 24px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      border: 1px solid rgba(0, 0, 0, 0.06);
    }

    .funnel-step:hover {
      background: #fafafa;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      -webkit-transform: translateY(-1px);
      transform: translateY(-1px);
    }

    .step-header {
      display: -webkit-box;
      display: -webkit-flex;
      display: flex;
      -webkit-box-pack: justify;
      -webkit-justify-content: space-between;
      justify-content: space-between;
      -webkit-box-align: center;
      -webkit-align-items: center;
      align-items: center;
      margin-bottom: 16px;
    }

    .step-title {
      font-weight: 600;
      font-size: 1.05rem;
      color: #1d1d1f;
      letter-spacing: -0.01em;
    }

    .step-badge {
      background: rgba(0, 0, 0, 0.04);
      color: #86868b;
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 0.75rem;
      font-weight: 400;
      letter-spacing: 0;
    }

    .step-inputs {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      -webkit-box-sizing: border-box;
    }

    .input-group {
      display: -webkit-box;
      display: -webkit-flex;
      display: flex;
      -webkit-box-orient: vertical;
      -webkit-box-direction: normal;
      -webkit-flex-direction: column;
      flex-direction: column;
      gap: 8px;
    }

    label {
      font-size: 0.875rem;
      color: #6e6e73;
      font-weight: 400;
      letter-spacing: -0.005em;
    }

    input[type="number"] {
      padding: 12px 16px;
      border: 1px solid rgba(0, 0, 0, 0.1);
      border-radius: 10px;
      font-size: 1rem;
      background: white;
      transition: all 0.2s ease;
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', system-ui, sans-serif;
      color: #1d1d1f;
      -webkit-appearance: none;
      -moz-appearance: textfield;
    }

    input[type="number"]:hover {
      border-color: rgba(0, 0, 0, 0.2);
    }

    input[type="number"]:focus {
      outline: none;
      border-color: #007aff;
      box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.15);
      -webkit-appearance: none;
    }

    .conversion-display {
      display: -webkit-box;
      display: -webkit-flex;
      display: flex;
      -webkit-box-align: baseline;
      -webkit-align-items: baseline;
      align-items: baseline;
      gap: 8px;
      margin-top: 12px;
      padding: 12px 16px;
      background: white;
      border-radius: 10px;
      border: 1px solid rgba(0, 0, 0, 0.04);
    }

    .conversion-rate {
      font-size: 1.75rem;
      font-weight: 600;
      color: #007aff;
      letter-spacing: -0.02em;
    }

    .conversion-label {
      color: #86868b;
      font-size: 0.875rem;
      font-weight: 400;
    }

    .improvement-section {
      background: #fff9e6;
      border-radius: 12px;
      padding: 24px;
      border: 1px solid rgba(255, 193, 7, 0.2);
    }

    .improvement-inputs {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
      margin-top: 15px;
      -webkit-box-sizing: border-box;
    }

    .btn-calculate {
      width: 100%;
      padding: 16px 24px;
      background: #007aff;
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 1.0625rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      margin: 32px 0;
      letter-spacing: -0.01em;
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', system-ui, sans-serif;
    }

    .btn-calculate:hover {
      background: #0051d5;
      -webkit-transform: scale(1.01);
      transform: scale(1.01);
    }

    .btn-calculate:active {
      -webkit-transform: scale(0.98);
      transform: scale(0.98);
    }

    .results {
      display: none;
      background: white;
      border-radius: 16px;
      padding: 32px;
      border: 1px solid rgba(0, 0, 0, 0.06);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
    }

    .results.show {
      display: block;
    }

    .results-title {
      font-size: 1.5rem;
      font-weight: 600;
      color: #1d1d1f;
      margin-bottom: 24px;
      text-align: center;
      letter-spacing: -0.02em;
    }

    .results-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
      -webkit-box-sizing: border-box;
    }

    .result-card {
      background: #f5f5f7;
      border-radius: 12px;
      padding: 24px;
      text-align: center;
      border: 1px solid rgba(0, 0, 0, 0.04);
    }

    .result-label {
      font-size: 0.875rem;
      color: #6e6e73;
      margin-bottom: 12px;
      font-weight: 400;
    }

    .result-value {
      font-size: 2rem;
      font-weight: 600;
      color: #1d1d1f;
      letter-spacing: -0.02em;
    }

    .result-unit {
      font-size: 0.875rem;
      color: #86868b;
      margin-left: 4px;
      font-weight: 400;
    }

    .impact-highlight {
      background: linear-gradient(135deg, #34c759 0%, #30d158 100%);
      color: white;
      padding: 32px;
      border-radius: 16px;
      text-align: center;
      box-shadow: 0 4px 12px rgba(52, 199, 89, 0.25);
    }

    .impact-value {
      font-size: 3rem;
      font-weight: 600;
      margin: 12px 0;
      letter-spacing: -0.03em;
    }

    .arrow-down {
      text-align: center;
      color: #86868b;
      font-size: 1.25rem;
      margin: 8px 0;
    }

    .save-section {
      background: #f5f5f7;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 32px;
      border: 1px solid rgba(0, 0, 0, 0.06);
    }

    .save-controls {
      display: -webkit-box;
      display: -webkit-flex;
      display: flex;
      gap: 12px;
      -webkit-box-align: center;
      -webkit-align-items: center;
      align-items: center;
      -webkit-flex-wrap: wrap;
      flex-wrap: wrap;
    }

    input[type="date"], input[type="text"] {
      padding: 12px 16px;
      border: 1px solid rgba(0, 0, 0, 0.1);
      border-radius: 10px;
      font-size: 1rem;
      background: white;
      transition: all 0.2s ease;
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', system-ui, sans-serif;
      color: #1d1d1f;
      -webkit-appearance: none;
    }

    input[type="date"]:focus, input[type="text"]:focus {
      outline: none;
      border-color: #007aff;
      box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.15);
      -webkit-appearance: none;
    }

    .btn-save {
      padding: 12px 20px;
      background: #34c759;
      color: white;
      border: none;
      border-radius: 10px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', system-ui, sans-serif;
      font-size: 0.9375rem;
    }

    .btn-save:hover {
      background: #30d158;
      transform: scale(1.02);
    }

    .btn-save:active {
      transform: scale(0.98);
    }

    .saved-data-list {
      margin-top: 20px;
      max-height: 400px;
      overflow-y: visible;
      overflow-x: visible;
    }

    .saved-item {
      background: white;
      border-radius: 10px;
      padding: 16px;
      margin-bottom: 12px;
      display: -webkit-box;
      display: -webkit-flex;
      display: flex;
      -webkit-box-pack: justify;
      -webkit-justify-content: space-between;
      justify-content: space-between;
      -webkit-box-align: start;
      -webkit-align-items: flex-start;
      align-items: flex-start;
      border: 1px solid rgba(0, 0, 0, 0.06);
      transition: all 0.2s ease;
      cursor: pointer;
      position: relative;
    }

    .saved-item:hover {
      border-color: #007aff;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      transform: translateY(-1px);
    }

    .saved-item-info {
      flex: 1;
      margin-right: 16px;
    }

    .saved-item-date {
      font-weight: 600;
      color: #1d1d1f;
      font-size: 1rem;
      margin-bottom: 6px;
      letter-spacing: -0.01em;
    }

    .saved-item-stats {
      font-size: 0.8125rem;
      color: #6e6e73;
      font-weight: 400;
    }

    .saved-item-actions {
      display: -webkit-box;
      display: -webkit-flex;
      display: flex;
      gap: 8px;
      -webkit-flex-shrink: 0;
      flex-shrink: 0;
    }

    .btn-load, .btn-delete {
      padding: 8px 16px;
      border: none;
      border-radius: 8px;
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', system-ui, sans-serif;
      white-space: nowrap;
    }

    .btn-load {
      background: #007aff;
      color: white;
    }

    .btn-load:hover {
      background: #0051d5;
      transform: scale(1.02);
    }

    .btn-delete {
      background: #ff3b30;
      color: white;
    }

    .btn-delete:hover {
      background: #d70015;
      transform: scale(1.02);
    }

    .loading-message {
      display: none;
      text-align: center;
      padding: 30px;
      background: #f0f4ff;
      border-radius: 12px;
      margin-top: 15px;
    }

    .loading-message.show {
      display: block;
    }

    .spinner {
      width: 40px;
      height: 40px;
      margin: 0 auto 15px;
      border: 4px solid #e0e0e0;
      border-top: 4px solid #5a6c7d;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .loading-text {
      font-size: 1rem;
      font-weight: 600;
      color: #5a6c7d;
    }

    /* íƒ­ ìŠ¤íƒ€ì¼ */
    .tabs {
      display: -webkit-box;
      display: -webkit-flex;
      display: flex;
      gap: 8px;
      margin-bottom: 32px;
      border-bottom: 1px solid rgba(0, 0, 0, 0.08);
    }

    .tab {
      padding: 12px 24px;
      background: transparent;
      border: none;
      border-bottom: 2px solid transparent;
      font-size: 1rem;
      font-weight: 500;
      color: #86868b;
      cursor: pointer;
      transition: all 0.2s ease;
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', system-ui, sans-serif;
      letter-spacing: -0.01em;
    }

    .tab:hover {
      color: #1d1d1f;
    }

    .tab.active {
      color: #007aff;
      border-bottom-color: #007aff;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* íˆ´íŒ ìŠ¤íƒ€ì¼ */
    .info-tooltip:hover .tooltip-text {
      visibility: visible !important;
      opacity: 1 !important;
    }

    .tooltip-text {
      pointer-events: none;
    }

    /* ëª¨ë°”ì¼ ë°˜ì‘í˜• ë””ìì¸ */
    @media (max-width: 768px) {
      body {
        padding: 20px 12px;
      }

      h1 {
        font-size: 1.75rem;
      }

      .subtitle {
        font-size: 1rem;
        margin-bottom: 32px;
      }

      .calculator {
        padding: 20px 16px;
        border-radius: 12px;
      }

      .section {
        margin-bottom: 32px;
      }

      .section-title {
        font-size: 1.25rem;
        margin-bottom: 16px;
      }

      .funnel-step {
        padding: 16px;
      }

      .step-header {
        -webkit-box-orient: vertical;
        -webkit-box-direction: normal;
        -webkit-flex-direction: column;
        flex-direction: column;
        -webkit-box-align: start;
        -webkit-align-items: flex-start;
        align-items: flex-start;
        gap: 8px;
      }

      .step-title {
        font-size: 0.95rem;
      }

      .step-inputs {
        grid-template-columns: 1fr;
      }

      .improvement-inputs {
        grid-template-columns: 1fr;
      }

      .results-grid {
        grid-template-columns: 1fr;
      }

      .save-controls {
        -webkit-box-orient: vertical;
        -webkit-box-direction: normal;
        -webkit-flex-direction: column;
        flex-direction: column;
        gap: 8px;
      }

      .save-controls input,
      .save-controls button {
        width: 100%;
      }

      .saved-item {
        -webkit-box-orient: vertical;
        -webkit-box-direction: normal;
        -webkit-flex-direction: column;
        flex-direction: column;
        gap: 12px;
      }

      .saved-item-actions {
        width: 100%;
        -webkit-box-pack: stretch;
        -webkit-justify-content: stretch;
        justify-content: stretch;
      }

      .saved-item-actions button {
        -webkit-box-flex: 1;
        -webkit-flex: 1;
        flex: 1;
      }

      .conversion-display {
        -webkit-box-orient: vertical;
        -webkit-box-direction: normal;
        -webkit-flex-direction: column;
        flex-direction: column;
        -webkit-box-align: start;
        -webkit-align-items: flex-start;
        align-items: flex-start;
        gap: 4px;
      }

      .conversion-rate {
        font-size: 1.5rem;
      }

      .impact-value {
        font-size: 2rem;
      }

      .result-value {
        font-size: 1.5rem;
      }

      /* í†µí™”ë³„ ê·¸ë¦¬ë“œ ì¡°ì • */
      .tabs {
        gap: 4px;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }

      .tab {
        padding: 10px 16px;
        font-size: 0.875rem;
        white-space: nowrap;
      }
    }

    @media (max-width: 480px) {
      h1 {
        font-size: 1.5rem;
      }

      .subtitle {
        font-size: 0.875rem;
      }

      .calculator {
        padding: 16px 12px;
      }

      .section-title {
        font-size: 1.125rem;
      }

      .step-title {
        font-size: 0.875rem;
      }

      input[type="number"],
      input[type="date"],
      input[type="text"],
      select {
        font-size: 16px !important; /* iOSì—ì„œ ìë™ ì¤Œ ë°©ì§€ */
      }

      .btn-calculate {
        padding: 14px 20px;
        font-size: 1rem;
      }

      .conversion-rate {
        font-size: 1.25rem;
      }

      .impact-value {
        font-size: 1.75rem;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ì„íŒ©íŠ¸ ì‹œë®¬ë ˆì´í„°</h1>
    <div class="subtitle">í¼ë„ ì „í™˜ìœ¨ ë³€í™”ì— ë”°ë¥¸ ë¹„ì¦ˆë‹ˆìŠ¤ íš¨ê³¼ë¥¼ ê³„ì‚°í•©ë‹ˆë‹¤</div>

    <div class="calculator">
      <!-- íƒ­ ë„¤ë¹„ê²Œì´ì…˜ -->
      <div class="tabs">
        <button class="tab active" onclick="switchTab('funnel')">ì „ì²´ í¼ë„ ë¶„ì„</button>
        <button class="tab" onclick="switchTab('currency')">í†µí™”ë³„ ë¶„ì„</button>
      </div>

      <!-- Tab 1: ì „ì²´ í¼ë„ ë¶„ì„ -->
      <div id="funnel_tab" class="tab-content active">
      <!-- ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸° -->
      <div class="section">
        <div class="save-section">
          <div style="font-weight: 600; margin-bottom: 16px; font-size: 1.125rem; color: #1d1d1f; letter-spacing: -0.01em;">í¼ë„ ë°ì´í„° ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸°</div>
          <div class="save-controls">
            <input type="date" id="funnel_save_date" />
            <input type="text" id="funnel_save_label" placeholder="ë©”ëª¨ (ì„ íƒì‚¬í•­)" style="flex: 1; min-width: 200px;" />
            <button class="btn-save" onclick="saveFunnelData()">í˜„ì¬ ì§€í‘œ ì €ì¥</button>
            <button class="btn-save" onclick="refreshFunnelData()" style="background: #007aff;">ìƒˆë¡œê³ ì¹¨</button>
          </div>

          <div style="height: 1px; background: rgba(0, 0, 0, 0.08); margin: 24px 0;"></div>

          <div style="font-weight: 600; margin-bottom: 16px; font-size: 1rem; color: #1d1d1f; letter-spacing: -0.01em;">ì €ì¥ëœ í¼ë„ ë°ì´í„°</div>

          <!-- ë¡œë”© ë©”ì‹œì§€ -->
          <div class="loading-message" id="funnel_loadingMessage">
            <div class="spinner"></div>
            <div class="loading-text">êµ¬ê¸€ ì‹œíŠ¸ ë°ì´í„° ë™ê¸°í™” ì¤‘...</div>
          </div>

          <div class="saved-data-list" id="funnel_savedDataList"></div>
        </div>
      </div>

      <!-- í˜„ì¬ ì§€í‘œ -->
      <div class="section">
        <div class="section-title">í˜„ì¬ ì§€í‘œ</div>

        <div class="funnel-container">
          <!-- Step 1: íšŒì›ê°€ì… -->
          <div class="funnel-step">
            <div class="step-header">
              <div class="step-title">1ï¸âƒ£ íšŒì›ê°€ì…</div>
              <div class="step-badge">ì‹œì‘ì </div>
            </div>
            <div class="step-inputs">
              <div class="input-group">
                <label>ì›”ê°„ ì‹ ê·œ ê°€ì…ì ìˆ˜</label>
                <input type="number" id="signups" value="1000" min="0">
              </div>
            </div>
          </div>

          <div class="arrow-down">â†“</div>

          <!-- Step 2: KYC -->
          <div class="funnel-step">
            <div class="step-header">
              <div class="step-title">2ï¸âƒ£ KYC ì™„ë£Œ</div>
              <div class="step-badge">ë³¸ì¸ì¸ì¦</div>
            </div>
            <div class="step-inputs">
              <div class="input-group">
                <label>KYC ì™„ë£Œìœ¨ (%)</label>
                <input type="number" id="kyc_rate" value="70" min="0" max="100" step="0.1">
              </div>
            </div>
            <div class="conversion-display">
              <span class="conversion-rate" id="kyc_users">700</span>
              <span class="conversion-label">ëª…ì´ KYC ì™„ë£Œ</span>
            </div>
          </div>

          <div class="arrow-down">â†“</div>

          <!-- Step 3: ì†¡ê¸ˆì‹ ì²­ ì‹œì‘ -->
          <div class="funnel-step">
            <div class="step-header">
              <div class="step-title">3ï¸âƒ£ ì†¡ê¸ˆì‹ ì²­ ì‹œì‘</div>
              <div class="step-badge">ì‹ ì²­ ì°©ìˆ˜</div>
            </div>
            <div class="step-inputs">
              <div class="input-group">
                <label>ì†¡ê¸ˆì‹ ì²­ ì‹œì‘ìœ¨ (%)</label>
                <input type="number" id="start_rate" value="60" min="0" max="100" step="0.1">
              </div>
            </div>
            <div class="conversion-display">
              <span class="conversion-rate" id="start_users">420</span>
              <span class="conversion-label">ëª…ì´ ì†¡ê¸ˆì‹ ì²­ ì‹œì‘</span>
            </div>
          </div>

          <div class="arrow-down">â†“</div>

          <!-- Step 4: ì†¡ê¸ˆì‹ ì²­ ì™„ë£Œ -->
          <div class="funnel-step">
            <div class="step-header">
              <div class="step-title">4ï¸âƒ£ ì†¡ê¸ˆì‹ ì²­ ì™„ë£Œ</div>
              <div class="step-badge">ì‹ ì²­ ì œì¶œ</div>
            </div>
            <div class="step-inputs">
              <div class="input-group">
                <label>ì†¡ê¸ˆì‹ ì²­ ì™„ë£Œìœ¨ (%)</label>
                <input type="number" id="complete_rate" value="80" min="0" max="100" step="0.1">
              </div>
            </div>
            <div class="conversion-display">
              <span class="conversion-rate" id="complete_users">336</span>
              <span class="conversion-label">ëª…ì´ ì†¡ê¸ˆì‹ ì²­ ì™„ë£Œ</span>
            </div>
          </div>

          <div class="arrow-down">â†“</div>

          <!-- Step 5: ì…ê¸ˆì™„ë£Œ -->
          <div class="funnel-step">
            <div class="step-header">
              <div class="step-title">5ï¸âƒ£ ì…ê¸ˆì™„ë£Œ</div>
              <div class="step-badge">ìê¸ˆ ì˜ˆì¹˜</div>
            </div>
            <div class="step-inputs">
              <div class="input-group">
                <label>ì…ê¸ˆì™„ë£Œìœ¨ (%)</label>
                <input type="number" id="deposit_rate" value="85" min="0" max="100" step="0.1">
              </div>
            </div>
            <div class="conversion-display">
              <span class="conversion-rate" id="deposit_users">286</span>
              <span class="conversion-label">ëª…ì´ ì…ê¸ˆì™„ë£Œ</span>
            </div>
          </div>

          <div class="arrow-down">â†“</div>

          <!-- Step 6: ì†¡ê¸ˆì™„ë£Œ -->
          <div class="funnel-step">
            <div class="step-header">
              <div class="step-title">6ï¸âƒ£ ì†¡ê¸ˆì™„ë£Œ</div>
              <div class="step-badge">ìµœì¢… ì „í™˜</div>
            </div>
            <div class="step-inputs">
              <div class="input-group">
                <label>ì†¡ê¸ˆì™„ë£Œìœ¨ (%)</label>
                <input type="number" id="remit_rate" value="95" min="0" max="100" step="0.1">
              </div>
            </div>
            <div class="conversion-display">
              <span class="conversion-rate" id="remit_users">272</span>
              <span class="conversion-label">ëª…ì´ ì²«ì†¡ê¸ˆ ì™„ë£Œ</span>
            </div>
          </div>
        </div>

        <!-- ì „ì²´ ì „í™˜ìœ¨ í‘œì‹œ -->
        <div style="margin-top: 24px; padding: 28px; background: linear-gradient(135deg, #007aff 0%, #0051d5 100%); color: white; border-radius: 16px; text-align: center; box-shadow: 0 4px 12px rgba(0, 122, 255, 0.25);">
          <div style="font-size: 0.9375rem; margin-bottom: 8px; opacity: 0.9; font-weight: 400;">ì „ì²´ ì „í™˜ìœ¨ (ê°€ì… â†’ ì²«ì†¡ê¸ˆ)</div>
          <div style="font-size: 3rem; font-weight: 600; letter-spacing: -0.03em;" id="overall_rate">27.2%</div>
        </div>
      </div>

      <!-- ë¹„ì¦ˆë‹ˆìŠ¤ ì§€í‘œ -->
      <div class="section">
        <div class="section-title">ë¹„ì¦ˆë‹ˆìŠ¤ ì§€í‘œ</div>
        <div class="step-inputs">
          <div class="input-group">
            <label>í‰ê·  ì²«ì†¡ê¸ˆ ê¸ˆì•¡ (ì›)</label>
            <input type="number" id="avg_amount" value="1000000" min="0" step="10000">
          </div>
          <div class="input-group">
            <label>í‰ê·  ìˆ˜ìˆ˜ë£Œìœ¨ (%)</label>
            <input type="number" id="fee_rate" value="0.8" min="0" max="100" step="0.01">
          </div>
        </div>
      </div>

      <!-- ê°œì„  ì‹œë‚˜ë¦¬ì˜¤ -->
      <div class="section">
        <div class="section-title">ê°œì„  ì‹œë‚˜ë¦¬ì˜¤</div>
        <div class="improvement-section">
          <div style="font-weight: 600; margin-bottom: 16px; color: #1d1d1f; font-size: 1rem;">ì–´ëŠ ë‹¨ê³„ë¥¼ ê°œì„ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</div>
          <div class="improvement-inputs">
            <div class="input-group">
              <label>ê°œì„  íƒ€ê²Ÿ KYC ì™„ë£Œìœ¨ (%)</label>
              <input type="number" id="target_kyc" value="70" min="0" max="100" step="0.1">
            </div>
            <div class="input-group">
              <label>ê°œì„  íƒ€ê²Ÿ ì†¡ê¸ˆì‹ ì²­ ì‹œì‘ìœ¨ (%)</label>
              <input type="number" id="target_start" value="60" min="0" max="100" step="0.1">
            </div>
            <div class="input-group">
              <label>ê°œì„  íƒ€ê²Ÿ ì†¡ê¸ˆì‹ ì²­ ì™„ë£Œìœ¨ (%)</label>
              <input type="number" id="target_complete" value="80" min="0" max="100" step="0.1">
            </div>
            <div class="input-group">
              <label>ê°œì„  íƒ€ê²Ÿ ì…ê¸ˆì™„ë£Œìœ¨ (%)</label>
              <input type="number" id="target_deposit" value="85" min="0" max="100" step="0.1">
            </div>
            <div class="input-group">
              <label>ê°œì„  íƒ€ê²Ÿ ì†¡ê¸ˆì™„ë£Œìœ¨ (%)</label>
              <input type="number" id="target_remit" value="95" min="0" max="100" step="0.1">
            </div>
          </div>
        </div>
      </div>

      <button class="btn-calculate" onclick="calculate()">ğŸ’¡ ì„íŒ©íŠ¸ ê³„ì‚°í•˜ê¸°</button>

      <!-- ê²°ê³¼ -->
      <div class="results" id="results">
        <div class="results-title">ğŸ“ˆ ì˜ˆìƒ ë¹„ì¦ˆë‹ˆìŠ¤ ì„íŒ©íŠ¸</div>

        <div class="impact-highlight">
          <div style="font-size: 1.2rem;">ê°œì„  í›„ ì „ì²´ ì „í™˜ìœ¨</div>
          <div class="impact-value" id="result_new_rate">-</div>
          <div style="font-size: 1rem; opacity: 0.9;">
            (<span id="result_rate_diff">-</span> ì¦ê°€)
          </div>
        </div>

        <div style="height: 30px;"></div>

        <div class="results-grid">
          <div class="result-card">
            <div class="result-label">ì¶”ê°€ ì²«ì†¡ê¸ˆ ìœ ì €</div>
            <div class="result-value" id="result_additional_users">-</div>
            <div class="result-unit">ëª…/ì›”</div>
          </div>

          <div class="result-card">
            <div class="result-label">ì¶”ê°€ ì†¡ê¸ˆì•¡ (GMV)</div>
            <div class="result-value" id="result_additional_gmv">-</div>
            <div class="result-unit">ì›/ì›”</div>
          </div>

          <div class="result-card">
            <div class="result-label">ì¶”ê°€ ìˆ˜ìˆ˜ë£Œ ìˆ˜ìµ</div>
            <div class="result-value" id="result_additional_revenue">-</div>
            <div class="result-unit">ì›/ì›”</div>
          </div>

          <div class="result-card">
            <div class="result-label">ì—°ê°„ ì˜ˆìƒ ìˆ˜ìµ ì¦ê°€</div>
            <div class="result-value" id="result_yearly_revenue">-</div>
            <div class="result-unit">ì›/ë…„</div>
          </div>
        </div>
      </div>
      </div>
      <!-- End of Tab 1: ì „ì²´ í¼ë„ ë¶„ì„ -->

      <!-- Tab 2: í†µí™”ë³„ ë¶„ì„ -->
      <div id="currency_tab" class="tab-content">
        <!-- ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸° -->
        <div class="section">
          <div class="save-section">
            <div style="font-weight: 600; margin-bottom: 16px; font-size: 1.125rem; color: #1d1d1f; letter-spacing: -0.01em;">í†µí™”ë³„ ë°ì´í„° ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸°</div>
            <div class="save-controls">
              <input type="date" id="currency_save_date" />
              <input type="text" id="currency_save_label" placeholder="ë©”ëª¨ (ì„ íƒì‚¬í•­)" style="flex: 1; min-width: 200px;" />
              <button class="btn-save" onclick="saveCurrencyData()">í˜„ì¬ ì§€í‘œ ì €ì¥</button>
              <button class="btn-save" onclick="refreshCurrencyData()" style="background: #007aff;">ìƒˆë¡œê³ ì¹¨</button>
            </div>

            <div style="height: 1px; background: rgba(0, 0, 0, 0.08); margin: 24px 0;"></div>

            <div style="font-weight: 600; margin-bottom: 16px; font-size: 1rem; color: #1d1d1f; letter-spacing: -0.01em;">ì €ì¥ëœ í†µí™”ë³„ ë°ì´í„°</div>

            <!-- ë¡œë”© ë©”ì‹œì§€ -->
            <div class="loading-message" id="currency_loadingMessage">
              <div class="spinner"></div>
              <div class="loading-text">êµ¬ê¸€ ì‹œíŠ¸ ë°ì´í„° ë™ê¸°í™” ì¤‘...</div>
            </div>

            <div class="saved-data-list" id="currency_savedDataList"></div>
          </div>
        </div>

        <!-- ì†¡ê¸ˆì‹ ì²­ ì‹œì‘ ìœ ì € ìˆ˜ -->
        <div class="section">
          <div class="section-title">ê¸°ì¤€ ë°ì´í„°</div>
          <div class="step-inputs">
            <div class="input-group">
              <label>ì†¡ê¸ˆì‹ ì²­ ì‹œì‘ ìœ ì € ìˆ˜ (ëª…/ì›”)</label>
              <input type="number" id="currency_start_users" value="420" min="0">
              <div style="font-size: 0.8125rem; color: #86868b; margin-top: 4px;">ì „ì²´ í¼ë„ì—ì„œ Step 3ê¹Œì§€ ë„ë‹¬í•œ ìœ ì € ìˆ˜</div>
            </div>
          </div>
        </div>

        <!-- í†µí™”ë³„ ì†¡ê¸ˆì‹ ì²­ ì™„ë£Œìœ¨ ë° ë¹„ì¤‘ -->
        <div class="section">
          <div class="section-title">ğŸ’± í†µí™”ë³„ ì†¡ê¸ˆì‹ ì²­ ì™„ë£Œìœ¨ (ì‹ ì²­ ì‹œì‘ â†’ ì‹ ì²­ ì™„ë£Œ)</div>
          <div style="background: #f0f9ff; border-radius: 12px; padding: 24px; border: 1px solid rgba(0, 122, 255, 0.2);">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 16px;">
              <!-- JPY -->
              <div style="background: white; border-radius: 10px; padding: 16px; border: 1px solid rgba(0, 0, 0, 0.06);">
                <div style="font-weight: 600; margin-bottom: 12px; color: #1d1d1f; font-size: 0.9375rem;">ğŸ‡¯ğŸ‡µ JPY</div>
                <div class="input-group" style="margin-bottom: 12px;">
                  <label>ì„ íƒ ë¹„ì¤‘ (%)</label>
                  <input type="number" id="currency_jpy_ratio" value="40" min="0" max="100" step="0.1">
                </div>
                <div class="input-group">
                  <label>ì‹ ì²­ ì™„ë£Œìœ¨ (%)</label>
                  <input type="number" id="currency_jpy_rate" value="85" min="0" max="100" step="0.1">
                </div>
              </div>

              <!-- USD -->
              <div style="background: white; border-radius: 10px; padding: 16px; border: 1px solid rgba(0, 0, 0, 0.06);">
                <div style="font-weight: 600; margin-bottom: 12px; color: #1d1d1f; font-size: 0.9375rem;">ğŸ‡ºğŸ‡¸ USD</div>
                <div class="input-group" style="margin-bottom: 12px;">
                  <label>ì„ íƒ ë¹„ì¤‘ (%)</label>
                  <input type="number" id="currency_usd_ratio" value="25" min="0" max="100" step="0.1">
                </div>
                <div class="input-group">
                  <label>ì‹ ì²­ ì™„ë£Œìœ¨ (%)</label>
                  <input type="number" id="currency_usd_rate" value="82" min="0" max="100" step="0.1">
                </div>
              </div>

              <!-- EUR -->
              <div style="background: white; border-radius: 10px; padding: 16px; border: 1px solid rgba(0, 0, 0, 0.06);">
                <div style="font-weight: 600; margin-bottom: 12px; color: #1d1d1f; font-size: 0.9375rem;">ğŸ‡ªğŸ‡º EUR</div>
                <div class="input-group" style="margin-bottom: 12px;">
                  <label>ì„ íƒ ë¹„ì¤‘ (%)</label>
                  <input type="number" id="currency_eur_ratio" value="15" min="0" max="100" step="0.1">
                </div>
                <div class="input-group">
                  <label>ì‹ ì²­ ì™„ë£Œìœ¨ (%)</label>
                  <input type="number" id="currency_eur_rate" value="78" min="0" max="100" step="0.1">
                </div>
              </div>

              <!-- AUD -->
              <div style="background: white; border-radius: 10px; padding: 16px; border: 1px solid rgba(0, 0, 0, 0.06);">
                <div style="font-weight: 600; margin-bottom: 12px; color: #1d1d1f; font-size: 0.9375rem;">ğŸ‡¦ğŸ‡º AUD</div>
                <div class="input-group" style="margin-bottom: 12px;">
                  <label>ì„ íƒ ë¹„ì¤‘ (%)</label>
                  <input type="number" id="currency_aud_ratio" value="10" min="0" max="100" step="0.1">
                </div>
                <div class="input-group">
                  <label>ì‹ ì²­ ì™„ë£Œìœ¨ (%)</label>
                  <input type="number" id="currency_aud_rate" value="75" min="0" max="100" step="0.1">
                </div>
              </div>

              <!-- CAD -->
              <div style="background: white; border-radius: 10px; padding: 16px; border: 1px solid rgba(0, 0, 0, 0.06);">
                <div style="font-weight: 600; margin-bottom: 12px; color: #1d1d1f; font-size: 0.9375rem;">ğŸ‡¨ğŸ‡¦ CAD</div>
                <div class="input-group" style="margin-bottom: 12px;">
                  <label>ì„ íƒ ë¹„ì¤‘ (%)</label>
                  <input type="number" id="currency_cad_ratio" value="6" min="0" max="100" step="0.1">
                </div>
                <div class="input-group">
                  <label>ì‹ ì²­ ì™„ë£Œìœ¨ (%)</label>
                  <input type="number" id="currency_cad_rate" value="72" min="0" max="100" step="0.1">
                </div>
              </div>

              <!-- GBP -->
              <div style="background: white; border-radius: 10px; padding: 16px; border: 1px solid rgba(0, 0, 0, 0.06);">
                <div style="font-weight: 600; margin-bottom: 12px; color: #1d1d1f; font-size: 0.9375rem;">ğŸ‡¬ğŸ‡§ GBP</div>
                <div class="input-group" style="margin-bottom: 12px;">
                  <label>ì„ íƒ ë¹„ì¤‘ (%)</label>
                  <input type="number" id="currency_gbp_ratio" value="4" min="0" max="100" step="0.1">
                </div>
                <div class="input-group">
                  <label>ì‹ ì²­ ì™„ë£Œìœ¨ (%)</label>
                  <input type="number" id="currency_gbp_rate" value="76" min="0" max="100" step="0.1">
                </div>
              </div>
            </div>

            <!-- ë¹„ì¤‘ í•©ê³„ ë° ê²€ì¦ í‘œì‹œ -->
            <div style="margin-top: 24px; padding: 16px 20px; background: white; border-radius: 10px; border: 1px solid rgba(0, 0, 0, 0.06);">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <div style="flex: 1;">
                  <div style="font-size: 0.875rem; color: #6e6e73; margin-bottom: 4px;">ì…ë ¥ëœ í†µí™” ë¹„ì¤‘ í•©ê³„</div>
                  <div style="font-size: 1.5rem; font-weight: 600;" id="currency_ratio_sum_display">100.0%</div>
                </div>
                <div id="currency_ratio_warning" style="display: none; padding: 8px 16px; background: #fff3cd; border: 1px solid #ffc107; border-radius: 8px; font-size: 0.875rem; color: #856404;">
                  âš ï¸ 100%ë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤
                </div>
              </div>

              <!-- ê¸°íƒ€ í†µí™” í‘œì‹œ -->
              <div id="currency_other_display" style="display: none; margin-top: 12px; padding: 12px; background: #f0f9ff; border-radius: 8px; border: 1px solid rgba(0, 122, 255, 0.2);">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <div>
                    <span style="font-weight: 600; color: #1d1d1f;">ê¸°íƒ€ í†µí™”</span>
                    <span style="font-size: 0.875rem; color: #86868b; margin-left: 8px;">ë¹„ì¤‘: <span id="currency_other_ratio">0%</span></span>
                  </div>
                  <div style="font-size: 0.875rem; color: #6e6e73; display: flex; align-items: center; gap: 6px;">
                    ê°€ì • ì™„ë£Œìœ¨: <span style="font-weight: 600; color: #007aff;" id="currency_other_rate">80%</span>
                    <span class="info-tooltip" style="position: relative; display: inline-flex; align-items: center; cursor: help;">
                      <span style="display: inline-flex; align-items: center; justify-content: center; width: 16px; height: 16px; background: rgba(0, 122, 255, 0.1); color: #007aff; border-radius: 50%; font-size: 12px; font-weight: 600;">â“˜</span>
                      <span class="tooltip-text" style="visibility: hidden; opacity: 0; position: absolute; bottom: calc(100% + 8px); right: -60px; background: #1d1d1f; color: white; padding: 8px 12px; border-radius: 6px; font-size: 0.75rem; white-space: nowrap; z-index: 9999; transition: opacity 0.2s ease; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);">
                        ì…ë ¥ëœ 6ê°œ í†µí™”ì˜ í‰ê·  ì™„ë£Œìœ¨ì„ ì‚¬ìš©í•©ë‹ˆë‹¤
                        <span style="position: absolute; top: 100%; right: 68px; width: 0; height: 0; border-left: 5px solid transparent; border-right: 5px solid transparent; border-top: 5px solid #1d1d1f;"></span>
                      </span>
                    </span>
                  </div>
                </div>
              </div>
            </div>

            <!-- í˜„ì¬ ê°€ì¤‘í‰ê·  ì™„ë£Œìœ¨ í‘œì‹œ -->
            <div style="margin-top: 16px; padding: 20px; background: white; border-radius: 10px; border: 1px solid rgba(0, 0, 0, 0.06);">
              <div style="text-align: center;">
                <div style="font-size: 0.875rem; color: #6e6e73; margin-bottom: 8px;">ì „ì²´ ê°€ì¤‘í‰ê·  ì‹ ì²­ ì™„ë£Œìœ¨</div>
                <div style="font-size: 2.5rem; font-weight: 600; color: #007aff; letter-spacing: -0.02em;" id="currency_weighted_rate">-</div>
                <div style="font-size: 0.875rem; color: #86868b; margin-top: 4px;">
                  ì†¡ê¸ˆì‹ ì²­ ì™„ë£Œ ìœ ì €: <span style="font-weight: 600; color: #1d1d1f;" id="currency_completed_users">-</span>ëª…
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- í†µí™”ë³„ ê°œì„  ì‹œë‚˜ë¦¬ì˜¤ -->
        <div class="section">
          <div class="section-title">ğŸ¯ íŠ¹ì • í†µí™” ê°œì„  ì‹œë‚˜ë¦¬ì˜¤</div>
          <div class="improvement-section">
            <div style="font-weight: 600; margin-bottom: 16px; color: #1d1d1f; font-size: 1rem;">ì–´ëŠ í†µí™”ë¥¼ ê°œì„ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</div>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px;">
              <div class="input-group">
                <label>ê°œì„  ëŒ€ìƒ í†µí™”</label>
                <select id="target_currency" style="padding: 12px 16px; border: 1px solid rgba(0, 0, 0, 0.1); border-radius: 10px; font-size: 1rem; background: white; font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', system-ui, sans-serif; color: #1d1d1f;">
                  <option value="jpy">ğŸ‡¯ğŸ‡µ JPY</option>
                  <option value="usd">ğŸ‡ºğŸ‡¸ USD</option>
                  <option value="eur">ğŸ‡ªğŸ‡º EUR</option>
                  <option value="aud">ğŸ‡¦ğŸ‡º AUD</option>
                  <option value="cad">ğŸ‡¨ğŸ‡¦ CAD</option>
                  <option value="gbp">ğŸ‡¬ğŸ‡§ GBP</option>
                </select>
              </div>
              <div class="input-group">
                <label>ê°œì„  ëª©í‘œ ì™„ë£Œìœ¨ (%)</label>
                <input type="number" id="target_currency_rate" value="90" min="0" max="100" step="0.1">
              </div>
            </div>
          </div>
        </div>

        <button class="btn-calculate" onclick="calculateCurrencyImpact()">ğŸ’± í†µí™”ë³„ ì„íŒ©íŠ¸ ê³„ì‚°í•˜ê¸°</button>

        <!-- í†µí™”ë³„ ê²°ê³¼ -->
        <div class="results" id="currency_results">
          <div class="results-title">ğŸ’± í†µí™”ë³„ ê°œì„  ì„íŒ©íŠ¸</div>

          <div class="impact-highlight" style="background: linear-gradient(135deg, #007aff 0%, #0051d5 100%);">
            <div style="font-size: 1.2rem;">ì„ íƒí•œ í†µí™” ê°œì„  íš¨ê³¼</div>
            <div class="impact-value">
              <span id="currency_result_name">JPY ğŸ‡¯ğŸ‡µ</span>
            </div>
            <div style="font-size: 1.5rem; opacity: 0.95; margin-top: 8px;">
              í•´ë‹¹ í†µí™” ì™„ë£Œìœ¨: <span id="currency_result_current">85%</span> â†’ <span id="currency_result_target">90%</span>
            </div>
            <div style="font-size: 1.3rem; opacity: 0.95; margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.3);">
              ì „ì²´ ê°€ì¤‘í‰ê·  ì™„ë£Œìœ¨: <span id="currency_result_weighted_current">80.0%</span> â†’ <span id="currency_result_weighted_new">82.0%</span>
            </div>
            <div style="font-size: 1rem; opacity: 0.9; margin-top: 8px;">
              (<span id="currency_result_weighted_diff">+2.0%p</span> ì¦ê°€)
            </div>
          </div>

          <div style="height: 30px;"></div>

          <div class="results-grid">
            <div class="result-card">
              <div class="result-label">ì¶”ê°€ ì‹ ì²­ ì™„ë£Œ ìœ ì €</div>
              <div class="result-value" id="currency_result_users">-</div>
              <div class="result-unit">ëª…/ì›”</div>
            </div>

            <div class="result-card">
              <div class="result-label">ì¶”ê°€ ì†¡ê¸ˆì•¡ (GMV)</div>
              <div class="result-value" id="currency_result_gmv">-</div>
              <div class="result-unit">ì›/ì›”</div>
            </div>

            <div class="result-card">
              <div class="result-label">ì¶”ê°€ ìˆ˜ìˆ˜ë£Œ ìˆ˜ìµ</div>
              <div class="result-value" id="currency_result_revenue">-</div>
              <div class="result-unit">ì›/ì›”</div>
            </div>

            <div class="result-card">
              <div class="result-label">ì—°ê°„ ì˜ˆìƒ ìˆ˜ìµ ì¦ê°€</div>
              <div class="result-value" id="currency_result_yearly">-</div>
              <div class="result-unit">ì›/ë…„</div>
            </div>
          </div>
        </div>
      </div>
      <!-- End of Tab 2: í†µí™”ë³„ ë¶„ì„ -->
    </div>
  </div>

  <script>
    // ì‹¤ì‹œê°„ ê³„ì‚° ì—…ë°ì´íŠ¸
    function updateCalculations() {
      const signups = parseFloat(document.getElementById('signups').value) || 0;
      const kycRate = parseFloat(document.getElementById('kyc_rate').value) || 0;
      const startRate = parseFloat(document.getElementById('start_rate').value) || 0;
      const completeRate = parseFloat(document.getElementById('complete_rate').value) || 0;
      const depositRate = parseFloat(document.getElementById('deposit_rate').value) || 0;
      const remitRate = parseFloat(document.getElementById('remit_rate').value) || 0;

      const kycUsers = signups * (kycRate / 100);
      const startUsers = kycUsers * (startRate / 100);
      const completeUsers = startUsers * (completeRate / 100);
      const depositUsers = completeUsers * (depositRate / 100);
      const remitUsers = depositUsers * (remitRate / 100);

      document.getElementById('kyc_users').textContent = Math.round(kycUsers);
      document.getElementById('start_users').textContent = Math.round(startUsers);
      document.getElementById('complete_users').textContent = Math.round(completeUsers);
      document.getElementById('deposit_users').textContent = Math.round(depositUsers);
      document.getElementById('remit_users').textContent = Math.round(remitUsers);

      const overallRate = (remitUsers / signups) * 100;
      document.getElementById('overall_rate').textContent = overallRate.toFixed(1) + '%';
    }

    function calculate() {
      const signups = parseFloat(document.getElementById('signups').value) || 0;
      const avgAmount = parseFloat(document.getElementById('avg_amount').value) || 0;
      const feeRate = parseFloat(document.getElementById('fee_rate').value) || 0;

      // í˜„ì¬ ì „í™˜ìœ¨
      const currentKyc = parseFloat(document.getElementById('kyc_rate').value) || 0;
      const currentStart = parseFloat(document.getElementById('start_rate').value) || 0;
      const currentComplete = parseFloat(document.getElementById('complete_rate').value) || 0;
      const currentDeposit = parseFloat(document.getElementById('deposit_rate').value) || 0;
      const currentRemit = parseFloat(document.getElementById('remit_rate').value) || 0;

      // ê°œì„  í›„ ì „í™˜ìœ¨
      const targetKyc = parseFloat(document.getElementById('target_kyc').value) || 0;
      const targetStart = parseFloat(document.getElementById('target_start').value) || 0;
      const targetComplete = parseFloat(document.getElementById('target_complete').value) || 0;
      const targetDeposit = parseFloat(document.getElementById('target_deposit').value) || 0;
      const targetRemit = parseFloat(document.getElementById('target_remit').value) || 0;

      // í˜„ì¬ ìµœì¢… ì „í™˜ìœ¨
      const currentOverallRate = (currentKyc / 100) * (currentStart / 100) * (currentComplete / 100) * (currentDeposit / 100) * (currentRemit / 100);
      const currentRemitUsers = signups * currentOverallRate;

      // ê°œì„  í›„ ìµœì¢… ì „í™˜ìœ¨
      const newOverallRate = (targetKyc / 100) * (targetStart / 100) * (targetComplete / 100) * (targetDeposit / 100) * (targetRemit / 100);
      const newRemitUsers = signups * newOverallRate;

      // ì„íŒ©íŠ¸ ê³„ì‚°
      const additionalUsers = newRemitUsers - currentRemitUsers;
      const additionalGMV = additionalUsers * avgAmount;
      const additionalRevenue = additionalGMV * (feeRate / 100);
      const yearlyRevenue = additionalRevenue * 12;

      const rateDiff = ((newOverallRate - currentOverallRate) * 100).toFixed(1);

      // ê²°ê³¼ í‘œì‹œ
      document.getElementById('result_new_rate').textContent = (newOverallRate * 100).toFixed(1) + '%';
      document.getElementById('result_rate_diff').textContent = '+' + rateDiff + '%p';
      document.getElementById('result_additional_users').textContent = Math.round(additionalUsers).toLocaleString();
      document.getElementById('result_additional_gmv').textContent = Math.round(additionalGMV).toLocaleString();
      document.getElementById('result_additional_revenue').textContent = Math.round(additionalRevenue).toLocaleString();
      document.getElementById('result_yearly_revenue').textContent = Math.round(yearlyRevenue).toLocaleString();

      document.getElementById('results').classList.add('show');
      document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
    }

    // í˜„ì¬ ì§€í‘œ ì…ë ¥ ë³€ê²½ì‹œ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸
    ['signups', 'kyc_rate', 'start_rate', 'complete_rate', 'deposit_rate', 'remit_rate'].forEach(id => {
      document.getElementById(id).addEventListener('input', updateCalculations);
    });

    // ì´ˆê¸° ê³„ì‚° ë° ê°œì„  íƒ€ê²Ÿ ê¸°ë³¸ê°’ ì„¤ì •
    updateCalculations();
    document.getElementById('target_kyc').value = document.getElementById('kyc_rate').value;
    document.getElementById('target_start').value = document.getElementById('start_rate').value;
    document.getElementById('target_complete').value = document.getElementById('complete_rate').value;
    document.getElementById('target_deposit').value = document.getElementById('deposit_rate').value;
    document.getElementById('target_remit').value = document.getElementById('remit_rate').value;

    // ë°ì´í„° ì €ì¥ ê´€ë ¨ í•¨ìˆ˜ë“¤
    const STORAGE_KEY = 'remittance_metrics_data'; // localStorageëŠ” ìºì‹œìš©ìœ¼ë¡œë§Œ ì‚¬ìš©
    // ğŸ” í”„ë¡ì‹œ ì„œë²„ë¥¼ í†µí•´ Google Sheetsì— ì ‘ê·¼ (ë³´ì•ˆ ê°•í™”)
    const PROXY_API_URL = '/api/sheets';

    async function saveFunnelData() {
      const date = document.getElementById('funnel_save_date').value;
      if (!date) {
        alert('ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
      }

      // ê³ ìœ  ID: ë‚ ì§œ + ì‹œê°„ (ISO ë¬¸ìì—´)
      const id = new Date().toISOString();

      const data = {
        id: id,
        type: 'funnel',
        date: date,
        label: document.getElementById('funnel_save_label').value || '',
        signups: parseFloat(document.getElementById('signups').value) || 0,
        kycRate: parseFloat(document.getElementById('kyc_rate').value) || 0,
        startRate: parseFloat(document.getElementById('start_rate').value) || 0,
        completeRate: parseFloat(document.getElementById('complete_rate').value) || 0,
        depositRate: parseFloat(document.getElementById('deposit_rate').value) || 0,
        remitRate: parseFloat(document.getElementById('remit_rate').value) || 0,
        avgAmount: parseFloat(document.getElementById('avg_amount').value) || 0,
        feeRate: parseFloat(document.getElementById('fee_rate').value) || 0,
        savedAt: id
      };

      // ì „ì²´ ì „í™˜ìœ¨ ê³„ì‚°
      const overallRate = (data.kycRate / 100) * (data.startRate / 100) * (data.completeRate / 100) *
                          (data.depositRate / 100) * (data.remitRate / 100) * 100;
      data.overallRate = overallRate;

      try {
        // ğŸ” í”„ë¡ì‹œ ì„œë²„ë¥¼ í†µí•´ Google Sheetsì— ì €ì¥
        const response = await fetch(PROXY_API_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(data)
        });

        // localStorageì— ìºì‹œ ì €ì¥
        let savedData = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
        savedData.push(data);
        // ë‚ ì§œ ìµœì‹ ìˆœ, ê°™ì€ ë‚ ì§œëŠ” ì‹œê°„ ìµœì‹ ìˆœìœ¼ë¡œ ì •ë ¬
        savedData.sort((a, b) => new Date(b.savedAt) - new Date(a.savedAt));
        localStorage.setItem(STORAGE_KEY, JSON.stringify(savedData));

        // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
        document.getElementById('funnel_save_label').value = '';

        alert('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');

        // ë°ì´í„° ìƒˆë¡œê³ ì¹¨
        await refreshFunnelData();
      } catch (error) {
        console.error('ì €ì¥ ì‹¤íŒ¨:', error);
        alert('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
      }
    }

    async function saveCurrencyData() {
      const date = document.getElementById('currency_save_date').value;
      if (!date) {
        alert('ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
      }

      // ê³ ìœ  ID: ë‚ ì§œ + ì‹œê°„ (ISO ë¬¸ìì—´)
      const id = new Date().toISOString();

      const data = {
        id: id,
        type: 'currency',
        date: date,
        label: document.getElementById('currency_save_label').value || '',
        currencyStartUsers: parseFloat(document.getElementById('currency_start_users').value) || 0,
        jpyRatio: parseFloat(document.getElementById('currency_jpy_ratio').value) || 0,
        jpyRate: parseFloat(document.getElementById('currency_jpy_rate').value) || 0,
        usdRatio: parseFloat(document.getElementById('currency_usd_ratio').value) || 0,
        usdRate: parseFloat(document.getElementById('currency_usd_rate').value) || 0,
        eurRatio: parseFloat(document.getElementById('currency_eur_ratio').value) || 0,
        eurRate: parseFloat(document.getElementById('currency_eur_rate').value) || 0,
        audRatio: parseFloat(document.getElementById('currency_aud_ratio').value) || 0,
        audRate: parseFloat(document.getElementById('currency_aud_rate').value) || 0,
        cadRatio: parseFloat(document.getElementById('currency_cad_ratio').value) || 0,
        cadRate: parseFloat(document.getElementById('currency_cad_rate').value) || 0,
        gbpRatio: parseFloat(document.getElementById('currency_gbp_ratio').value) || 0,
        gbpRate: parseFloat(document.getElementById('currency_gbp_rate').value) || 0,
        avgAmount: parseFloat(document.getElementById('avg_amount').value) || 0,
        feeRate: parseFloat(document.getElementById('fee_rate').value) || 0,
        savedAt: id
      };

      // ê°€ì¤‘í‰ê·  ì™„ë£Œìœ¨ ê³„ì‚°
      const currencies = ['jpy', 'usd', 'eur', 'aud', 'cad', 'gbp'];
      let ratioSum = 0;
      let weightedRate = 0;
      currencies.forEach(curr => {
        const ratio = data[`${curr}Ratio`];
        const rate = data[`${curr}Rate`];
        ratioSum += ratio;
        weightedRate += (ratio / 100) * (rate / 100);
      });

      // ê¸°íƒ€ í†µí™” ì²˜ë¦¬ (ë¹„ì¤‘ì´ 100% ë¯¸ë§Œì¸ ê²½ìš°)
      if (ratioSum < 100) {
        const otherRatio = 100 - ratioSum;
        // ê¸°íƒ€ í†µí™” ê°€ì • ì™„ë£Œìœ¨ (6ê°œ í†µí™”ì˜ í‰ê·  ì™„ë£Œìœ¨ ì‚¬ìš©)
        let totalRate = 0;
        let count = 0;
        currencies.forEach(curr => {
          const rate = data[`${curr}Rate`];
          if (rate > 0) {
            totalRate += rate;
            count++;
          }
        });
        const otherRate = count > 0 ? (totalRate / count) : 80;
        weightedRate += (otherRatio / 100) * (otherRate / 100);
      }

      data.weightedRate = weightedRate * 100;
      data.completedUsers = data.currencyStartUsers * weightedRate;

      try {
        // ğŸ” í”„ë¡ì‹œ ì„œë²„ë¥¼ í†µí•´ Google Sheetsì— ì €ì¥
        const response = await fetch(PROXY_API_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(data)
        });

        // localStorageì— ìºì‹œ ì €ì¥
        let savedData = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
        savedData.push(data);
        // ë‚ ì§œ ìµœì‹ ìˆœ, ê°™ì€ ë‚ ì§œëŠ” ì‹œê°„ ìµœì‹ ìˆœìœ¼ë¡œ ì •ë ¬
        savedData.sort((a, b) => new Date(b.savedAt) - new Date(a.savedAt));
        localStorage.setItem(STORAGE_KEY, JSON.stringify(savedData));

        // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
        document.getElementById('currency_save_label').value = '';

        alert('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');

        // ë°ì´í„° ìƒˆë¡œê³ ì¹¨
        await refreshCurrencyData();
      } catch (error) {
        console.error('ì €ì¥ ì‹¤íŒ¨:', error);
        alert('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
      }
    }

    async function deleteFromGoogleSheets(id, type) {
      try {
        // ğŸ” í”„ë¡ì‹œ ì„œë²„ë¥¼ í†µí•´ Google Sheetsì—ì„œ ì‚­ì œ
        const response = await fetch(PROXY_API_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ action: 'delete', id: id, type: type })
        });
        console.log('Google Sheetsì—ì„œ ì‚­ì œ ì™„ë£Œ');
      } catch (error) {
        console.error('Google Sheets ì‚­ì œ ì‹¤íŒ¨:', error);
        throw error;
      }
    }

    function loadFunnelData(id) {
      const savedData = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
      const data = savedData.find(item => item.id === id);

      if (!data) {
        alert('ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      // ë°ì´í„° ë¡œë“œ
      document.getElementById('signups').value = data.signups;
      document.getElementById('kyc_rate').value = data.kycRate;
      document.getElementById('start_rate').value = data.startRate;
      document.getElementById('complete_rate').value = data.completeRate;
      document.getElementById('deposit_rate').value = data.depositRate;
      document.getElementById('remit_rate').value = data.remitRate;
      document.getElementById('avg_amount').value = data.avgAmount;
      document.getElementById('fee_rate').value = data.feeRate;

      // ê°œì„  íƒ€ê²Ÿë„ ë™ì¼í•˜ê²Œ ì„¤ì •
      document.getElementById('target_kyc').value = data.kycRate;
      document.getElementById('target_start').value = data.startRate;
      document.getElementById('target_complete').value = data.completeRate;
      document.getElementById('target_deposit').value = data.depositRate;
      document.getElementById('target_remit').value = data.remitRate;

      // ê³„ì‚° ì—…ë°ì´íŠ¸
      updateCalculations();

      alert('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤!');
    }

    function loadCurrencyData(id) {
      const savedData = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
      const data = savedData.find(item => item.id === id);

      if (!data) {
        alert('ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      // ë°ì´í„° ë¡œë“œ
      document.getElementById('currency_start_users').value = data.currencyStartUsers;
      document.getElementById('currency_jpy_ratio').value = data.jpyRatio;
      document.getElementById('currency_jpy_rate').value = data.jpyRate;
      document.getElementById('currency_usd_ratio').value = data.usdRatio;
      document.getElementById('currency_usd_rate').value = data.usdRate;
      document.getElementById('currency_eur_ratio').value = data.eurRatio;
      document.getElementById('currency_eur_rate').value = data.eurRate;
      document.getElementById('currency_aud_ratio').value = data.audRatio;
      document.getElementById('currency_aud_rate').value = data.audRate;
      document.getElementById('currency_cad_ratio').value = data.cadRatio;
      document.getElementById('currency_cad_rate').value = data.cadRate;
      document.getElementById('currency_gbp_ratio').value = data.gbpRatio;
      document.getElementById('currency_gbp_rate').value = data.gbpRate;
      document.getElementById('avg_amount').value = data.avgAmount;
      document.getElementById('fee_rate').value = data.feeRate;

      // ê°€ì¤‘í‰ê·  ì—…ë°ì´íŠ¸
      updateCurrencyWeightedRate();

      alert('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤!');
    }

    async function deleteFunnelData(id) {
      if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        return;
      }

      try {
        console.log('ì‚­ì œ ìš”ì²­ ID:', id);

        // Google Sheetsì—ì„œ ì‚­ì œ
        await deleteFromGoogleSheets(id, 'funnel');

        // localStorage ìºì‹œì—ì„œë„ ì‚­ì œ
        let savedData = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
        console.log('ì‚­ì œ ì „ ë°ì´í„° ê°œìˆ˜:', savedData.length);
        savedData = savedData.filter(item => item.id !== id);
        console.log('ì‚­ì œ í›„ ë°ì´í„° ê°œìˆ˜:', savedData.length);
        localStorage.setItem(STORAGE_KEY, JSON.stringify(savedData));

        alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');

        // ë°ì´í„° ìƒˆë¡œê³ ì¹¨
        await refreshFunnelData();
      } catch (error) {
        console.error('ì‚­ì œ ì‹¤íŒ¨:', error);
        alert('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
      }
    }

    async function deleteCurrencyData(id) {
      if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        return;
      }

      try {
        console.log('ì‚­ì œ ìš”ì²­ ID:', id);

        // Google Sheetsì—ì„œ ì‚­ì œ
        await deleteFromGoogleSheets(id, 'currency');

        // localStorage ìºì‹œì—ì„œë„ ì‚­ì œ
        let savedData = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
        console.log('ì‚­ì œ ì „ ë°ì´í„° ê°œìˆ˜:', savedData.length);
        savedData = savedData.filter(item => item.id !== id);
        console.log('ì‚­ì œ í›„ ë°ì´í„° ê°œìˆ˜:', savedData.length);
        localStorage.setItem(STORAGE_KEY, JSON.stringify(savedData));

        alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');

        // ë°ì´í„° ìƒˆë¡œê³ ì¹¨
        await refreshCurrencyData();
      } catch (error) {
        console.error('ì‚­ì œ ì‹¤íŒ¨:', error);
        alert('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
      }
    }

    function displayFunnelData() {
      const savedData = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
      const funnelData = savedData.filter(item => item.type === 'funnel' || !item.type); // í˜¸í™˜ì„±ì„ ìœ„í•´ typeì´ ì—†ëŠ” ë°ì´í„°ë„ í¬í•¨
      const container = document.getElementById('funnel_savedDataList');

      if (funnelData.length === 0) {
        container.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">ì €ì¥ëœ í¼ë„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
      }

      container.innerHTML = funnelData.map(data => {
        const dateObj = new Date(data.date);
        const displayDate = dateObj.toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric' });
        const timeObj = new Date(data.savedAt);
        const displayTime = timeObj.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
        const remitUsers = Math.round(data.signups * (data.overallRate / 100));

        return `
          <div class="saved-item">
            <div class="saved-item-info">
              <div class="saved-item-date">${data.label || 'ë©”ëª¨ ì—†ìŒ'}</div>
              <div class="saved-item-stats">
                ${displayDate} ${displayTime} | ê°€ì…ì: ${data.signups.toLocaleString()}ëª… |
                ì „ì²´ ì „í™˜ìœ¨: ${data.overallRate.toFixed(1)}% |
                ì²«ì†¡ê¸ˆ: ${remitUsers.toLocaleString()}ëª…
              </div>
            </div>
            <div class="saved-item-actions">
              <button class="btn-load" onclick="loadFunnelData('${data.id}')">ë¶ˆëŸ¬ì˜¤ê¸°</button>
              <button class="btn-delete" onclick="deleteFunnelData('${data.id}')">ì‚­ì œ</button>
            </div>
          </div>
        `;
      }).join('');
    }

    function displayCurrencyData() {
      const savedData = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
      const currencyData = savedData.filter(item => item.type === 'currency');
      const container = document.getElementById('currency_savedDataList');

      if (currencyData.length === 0) {
        container.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">ì €ì¥ëœ í†µí™”ë³„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
      }

      container.innerHTML = currencyData.map(data => {
        const dateObj = new Date(data.date);
        const displayDate = dateObj.toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric' });
        const timeObj = new Date(data.savedAt);
        const displayTime = timeObj.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
        const completedUsers = Math.round(data.completedUsers);

        return `
          <div class="saved-item">
            <div class="saved-item-info">
              <div class="saved-item-date">${data.label || 'ë©”ëª¨ ì—†ìŒ'}</div>
              <div class="saved-item-stats">
                ${displayDate} ${displayTime} | ì‹ ì²­ ì‹œì‘: ${data.currencyStartUsers.toLocaleString()}ëª… |
                ê°€ì¤‘í‰ê·  ì™„ë£Œìœ¨: ${data.weightedRate.toFixed(1)}% |
                ì‹ ì²­ ì™„ë£Œ: ${completedUsers.toLocaleString()}ëª…
              </div>
            </div>
            <div class="saved-item-actions">
              <button class="btn-load" onclick="loadCurrencyData('${data.id}')">ë¶ˆëŸ¬ì˜¤ê¸°</button>
              <button class="btn-delete" onclick="deleteCurrencyData('${data.id}')">ì‚­ì œ</button>
            </div>
          </div>
        `;
      }).join('');
    }

    function showFunnelLoading() {
      document.getElementById('funnel_loadingMessage').classList.add('show');
      document.getElementById('funnel_savedDataList').style.display = 'none';
    }

    function hideFunnelLoading() {
      document.getElementById('funnel_loadingMessage').classList.remove('show');
      document.getElementById('funnel_savedDataList').style.display = 'block';
    }

    function showCurrencyLoading() {
      document.getElementById('currency_loadingMessage').classList.add('show');
      document.getElementById('currency_savedDataList').style.display = 'none';
    }

    function hideCurrencyLoading() {
      document.getElementById('currency_loadingMessage').classList.remove('show');
      document.getElementById('currency_savedDataList').style.display = 'block';
    }

    async function refreshFunnelData() {
      showFunnelLoading();
      try {
        // ğŸ” í”„ë¡ì‹œ ì„œë²„ë¥¼ í†µí•´ Google Sheets ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        const timestamp = new Date().getTime();
        const response = await fetch(`${PROXY_API_URL}?timestamp=${timestamp}`);
        const data = await response.json();

        if (data.status === 'error') {
          console.error('ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:', data.message);
          hideFunnelLoading();
          return;
        }

        // ë°ì´í„°ê°€ ë°°ì—´ì¸ì§€ í™•ì¸
        if (!Array.isArray(data)) {
          console.error('ì˜ˆìƒì¹˜ ëª»í•œ ë°ì´í„° í˜•ì‹:', data);
          hideFunnelLoading();
          return;
        }

        // Google Sheets ë°ì´í„°ë¥¼ localStorage ìºì‹œì— ì €ì¥
        const sortedData = data.sort((a, b) => new Date(b.savedAt) - new Date(a.savedAt));
        localStorage.setItem(STORAGE_KEY, JSON.stringify(sortedData));

        // UI ì—…ë°ì´íŠ¸
        displayFunnelData();

        console.log(`${data.length}ê°œì˜ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.`);
        hideFunnelLoading();
      } catch (error) {
        console.error('Google Sheets ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:', error);
        // ì‹¤íŒ¨ ì‹œ localStorage ìºì‹œ ì‚¬ìš©
        displayFunnelData();
        hideFunnelLoading();
      }
    }

    async function refreshCurrencyData() {
      showCurrencyLoading();
      try {
        // ğŸ” í”„ë¡ì‹œ ì„œë²„ë¥¼ í†µí•´ Google Sheets ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        const timestamp = new Date().getTime();
        const response = await fetch(`${PROXY_API_URL}?timestamp=${timestamp}`);
        const data = await response.json();

        if (data.status === 'error') {
          console.error('ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:', data.message);
          hideCurrencyLoading();
          return;
        }

        // ë°ì´í„°ê°€ ë°°ì—´ì¸ì§€ í™•ì¸
        if (!Array.isArray(data)) {
          console.error('ì˜ˆìƒì¹˜ ëª»í•œ ë°ì´í„° í˜•ì‹:', data);
          hideCurrencyLoading();
          return;
        }

        // Google Sheets ë°ì´í„°ë¥¼ localStorage ìºì‹œì— ì €ì¥
        const sortedData = data.sort((a, b) => new Date(b.savedAt) - new Date(a.savedAt));
        localStorage.setItem(STORAGE_KEY, JSON.stringify(sortedData));

        // UI ì—…ë°ì´íŠ¸
        displayCurrencyData();

        console.log(`${data.length}ê°œì˜ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.`);
        hideCurrencyLoading();
      } catch (error) {
        console.error('Google Sheets ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:', error);
        // ì‹¤íŒ¨ ì‹œ localStorage ìºì‹œ ì‚¬ìš©
        displayCurrencyData();
        hideCurrencyLoading();
      }
    }

    // íƒ­ ì „í™˜ í•¨ìˆ˜
    function switchTab(tabName) {
      // ëª¨ë“  íƒ­ ë²„íŠ¼ ë¹„í™œì„±í™”
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
      // ëª¨ë“  íƒ­ ì½˜í…ì¸  ìˆ¨ê¸°ê¸°
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

      // ì„ íƒí•œ íƒ­ í™œì„±í™”
      if (tabName === 'funnel') {
        document.querySelector('.tab:nth-child(1)').classList.add('active');
        document.getElementById('funnel_tab').classList.add('active');
      } else if (tabName === 'currency') {
        document.querySelector('.tab:nth-child(2)').classList.add('active');
        document.getElementById('currency_tab').classList.add('active');
        // í†µí™”ë³„ íƒ­ìœ¼ë¡œ ì „í™˜ ì‹œ ê°€ì¤‘í‰ê·  ê³„ì‚°
        updateCurrencyWeightedRate();
      }
    }

    // í†µí™”ë³„ ê°€ì¤‘í‰ê·  ì™„ë£Œìœ¨ ê³„ì‚°
    function updateCurrencyWeightedRate() {
      const startUsers = parseFloat(document.getElementById('currency_start_users').value) || 0;
      const currencies = ['jpy', 'usd', 'eur', 'aud', 'cad', 'gbp'];

      // ë¹„ì¤‘ í•©ê³„ ê³„ì‚°
      let ratioSum = 0;
      let weightedRate = 0;

      currencies.forEach(curr => {
        const ratio = parseFloat(document.getElementById(`currency_${curr}_ratio`).value) || 0;
        const rate = parseFloat(document.getElementById(`currency_${curr}_rate`).value) || 0;
        ratioSum += ratio;
        weightedRate += (ratio / 100) * (rate / 100);
      });

      // ë¹„ì¤‘ í•©ê³„ í‘œì‹œ ì—…ë°ì´íŠ¸
      const ratioSumDisplay = document.getElementById('currency_ratio_sum_display');
      const ratioWarning = document.getElementById('currency_ratio_warning');
      const otherDisplay = document.getElementById('currency_other_display');

      ratioSumDisplay.textContent = ratioSum.toFixed(1) + '%';

      // 100% ì´ˆê³¼ ì‹œ ê²½ê³  í‘œì‹œ
      if (ratioSum > 100) {
        ratioSumDisplay.style.color = '#d32f2f';
        ratioWarning.style.display = 'block';
        otherDisplay.style.display = 'none';
      } else if (ratioSum < 100) {
        // 100% ë¯¸ë§Œì´ë©´ ê¸°íƒ€ í†µí™” í‘œì‹œ
        ratioSumDisplay.style.color = '#1d1d1f';
        ratioWarning.style.display = 'none';
        otherDisplay.style.display = 'block';

        const otherRatio = 100 - ratioSum;
        document.getElementById('currency_other_ratio').textContent = otherRatio.toFixed(1) + '%';

        // ê¸°íƒ€ í†µí™” ê°€ì • ì™„ë£Œìœ¨ (6ê°œ í†µí™”ì˜ í‰ê·  ì™„ë£Œìœ¨ ì‚¬ìš©)
        let totalRate = 0;
        let count = 0;
        currencies.forEach(curr => {
          const rate = parseFloat(document.getElementById(`currency_${curr}_rate`).value) || 0;
          if (rate > 0) {
            totalRate += rate;
            count++;
          }
        });
        const otherRate = count > 0 ? (totalRate / count) : 80;
        document.getElementById('currency_other_rate').textContent = otherRate.toFixed(1) + '%';

        // ê¸°íƒ€ í†µí™”ë¥¼ ê°€ì¤‘í‰ê· ì— í¬í•¨
        weightedRate += (otherRatio / 100) * (otherRate / 100);
      } else {
        // ì •í™•íˆ 100%
        ratioSumDisplay.style.color = '#34c759';
        ratioWarning.style.display = 'none';
        otherDisplay.style.display = 'none';
      }

      const completedUsers = startUsers * weightedRate;

      document.getElementById('currency_weighted_rate').textContent = (weightedRate * 100).toFixed(1) + '%';
      document.getElementById('currency_completed_users').textContent = Math.round(completedUsers).toLocaleString();
    }

    // í†µí™”ë³„ ì…ë ¥ í•„ë“œì— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
    ['currency_start_users', 'currency_jpy_ratio', 'currency_jpy_rate',
     'currency_usd_ratio', 'currency_usd_rate', 'currency_eur_ratio', 'currency_eur_rate',
     'currency_aud_ratio', 'currency_aud_rate', 'currency_cad_ratio', 'currency_cad_rate',
     'currency_gbp_ratio', 'currency_gbp_rate'].forEach(id => {
      const element = document.getElementById(id);
      if (element) {
        element.addEventListener('input', updateCurrencyWeightedRate);
      }
    });

    // í†µí™”ë³„ ì„íŒ©íŠ¸ ê³„ì‚° í•¨ìˆ˜
    function calculateCurrencyImpact() {
      const startUsers = parseFloat(document.getElementById('currency_start_users').value) || 0;
      const avgAmount = parseFloat(document.getElementById('avg_amount').value) || 0;
      const feeRate = parseFloat(document.getElementById('fee_rate').value) || 0;

      // í†µí™”ë³„ ë°ì´í„° ìˆ˜ì§‘
      const currencies = ['jpy', 'usd', 'eur', 'aud', 'cad', 'gbp'];
      const currencyData = {};

      currencies.forEach(curr => {
        currencyData[curr] = {
          ratio: parseFloat(document.getElementById(`currency_${curr}_ratio`).value) || 0,
          rate: parseFloat(document.getElementById(`currency_${curr}_rate`).value) || 0
        };
      });

      // ì„ íƒí•œ í†µí™”
      const targetCurrency = document.getElementById('target_currency').value;
      const targetRate = parseFloat(document.getElementById('target_currency_rate').value) || 0;

      // ë¹„ì¤‘ í•©ê³„ ê³„ì‚°
      let ratioSum = 0;
      currencies.forEach(curr => {
        ratioSum += currencyData[curr].ratio;
      });

      // í˜„ì¬ ì „ì²´ ì‹ ì²­ ì™„ë£Œì ê³„ì‚° (í†µí™”ë³„ ê°€ì¤‘í‰ê· )
      let currentWeightedRate = 0;
      currencies.forEach(curr => {
        currentWeightedRate += (currencyData[curr].ratio / 100) * (currencyData[curr].rate / 100);
      });

      // ê¸°íƒ€ í†µí™” ì²˜ë¦¬ (ë¹„ì¤‘ì´ 100% ë¯¸ë§Œì¸ ê²½ìš°)
      let otherRate = 0;
      if (ratioSum < 100) {
        const otherRatio = 100 - ratioSum;
        // ê¸°íƒ€ í†µí™” ê°€ì • ì™„ë£Œìœ¨ (6ê°œ í†µí™”ì˜ í‰ê·  ì™„ë£Œìœ¨ ì‚¬ìš©)
        let totalRate = 0;
        let count = 0;
        currencies.forEach(curr => {
          if (currencyData[curr].rate > 0) {
            totalRate += currencyData[curr].rate;
            count++;
          }
        });
        otherRate = count > 0 ? (totalRate / count) : 80;
        currentWeightedRate += (otherRatio / 100) * (otherRate / 100);
      }

      const currentCompletedUsers = startUsers * currentWeightedRate;

      // ê°œì„  í›„ ì „ì²´ ì‹ ì²­ ì™„ë£Œì ê³„ì‚°
      let newWeightedRate = 0;
      currencies.forEach(curr => {
        if (curr === targetCurrency) {
          newWeightedRate += (currencyData[curr].ratio / 100) * (targetRate / 100);
        } else {
          newWeightedRate += (currencyData[curr].ratio / 100) * (currencyData[curr].rate / 100);
        }
      });

      // ê°œì„  í›„ì—ë„ ê¸°íƒ€ í†µí™” í¬í•¨
      if (ratioSum < 100) {
        const otherRatio = 100 - ratioSum;
        newWeightedRate += (otherRatio / 100) * (otherRate / 100);
      }

      const newCompletedUsers = startUsers * newWeightedRate;

      // ì„íŒ©íŠ¸ ê³„ì‚°
      const additionalUsers = newCompletedUsers - currentCompletedUsers;
      const additionalGMV = additionalUsers * avgAmount;
      const additionalRevenue = additionalGMV * (feeRate / 100);
      const yearlyRevenue = additionalRevenue * 12;

      // í†µí™” ì´ë¦„ ë§¤í•‘
      const currencyNames = {
        jpy: 'JPY ğŸ‡¯ğŸ‡µ',
        usd: 'USD ğŸ‡ºğŸ‡¸',
        eur: 'EUR ğŸ‡ªğŸ‡º',
        aud: 'AUD ğŸ‡¦ğŸ‡º',
        cad: 'CAD ğŸ‡¨ğŸ‡¦',
        gbp: 'GBP ğŸ‡¬ğŸ‡§'
      };

      // ê°€ì¤‘í‰ê·  ë³€í™” ê³„ì‚°
      const weightedRateDiff = (newWeightedRate - currentWeightedRate) * 100;

      // ê²°ê³¼ í‘œì‹œ
      document.getElementById('currency_result_name').textContent = currencyNames[targetCurrency];
      document.getElementById('currency_result_current').textContent = currencyData[targetCurrency].rate.toFixed(1) + '%';
      document.getElementById('currency_result_target').textContent = targetRate.toFixed(1) + '%';

      // ê°€ì¤‘í‰ê·  ì™„ë£Œìœ¨ í‘œì‹œ
      document.getElementById('currency_result_weighted_current').textContent = (currentWeightedRate * 100).toFixed(1) + '%';
      document.getElementById('currency_result_weighted_new').textContent = (newWeightedRate * 100).toFixed(1) + '%';
      document.getElementById('currency_result_weighted_diff').textContent = '+' + weightedRateDiff.toFixed(1) + '%p';

      document.getElementById('currency_result_users').textContent = Math.round(additionalUsers).toLocaleString();
      document.getElementById('currency_result_gmv').textContent = Math.round(additionalGMV).toLocaleString();
      document.getElementById('currency_result_revenue').textContent = Math.round(additionalRevenue).toLocaleString();
      document.getElementById('currency_result_yearly').textContent = Math.round(yearlyRevenue).toLocaleString();

      document.getElementById('currency_results').classList.add('show');
      document.getElementById('currency_results').scrollIntoView({ behavior: 'smooth' });
    }

    // ì˜¤ëŠ˜ ë‚ ì§œë¡œ ì´ˆê¸°í™”
    document.getElementById('funnel_save_date').valueAsDate = new Date();
    document.getElementById('currency_save_date').valueAsDate = new Date();

    // í˜ì´ì§€ ë¡œë“œ ì‹œ Google Sheetsì—ì„œ ë°ì´í„° ìë™ ë¶ˆëŸ¬ì˜¤ê¸°
    refreshFunnelData();
    refreshCurrencyData();

    // í†µí™”ë³„ ê°€ì¤‘í‰ê·  ì´ˆê¸° ê³„ì‚°
    updateCurrencyWeightedRate();
  </script>
</body>
</html>
